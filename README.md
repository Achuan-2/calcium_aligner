# 钙成像配准软件

基于PySide6和Suite2p算法的钙成像TIFF堆栈配准软件。

![配准过程](https://github.com/user-attachments/assets/e0857971-df96-45a6-92a2-ab997cd11903)


## 功能特点

- **单个文件配准**: 支持单个TIFF文件的配准处理
- **批量文件配准**: 支持文件夹内多个TIFF文件的批量配准
- **自定义参考图像**: 支持使用自定义参考图像进行配准
- **实时预览**: 配准前后图像实时预览，支持帧选择
- **参数可调**: 支持调整配准参数，包括空间平滑、最大位移等
- **进度显示**: 批量处理时显示进度条和处理日志

## 安装要求

```bash
pip install -r requirements.txt
```

主要依赖：
- PySide6: GUI框架
- numpy, scipy: 数值计算
- tifffile: TIFF文件读写
- matplotlib: 图像显示

## 使用方法

### 启动软件

```bash
python calcium_aligner_gui.py
```

### 单个配准

1. 切换到"单个配准"标签页
2. 选择输入TIFF文件
3. 选择输出TIFF文件
4. （可选）选择自定义参考图像
5. 点击"加载数据"预览输入图像
6. 调整配准参数（可选）
7. 点击"开始配准"

**配准参数说明：**
- **空间平滑σ**: 空间平滑的标准差，默认1.125
- **最大位移比例**: 最大位移相对于图像尺寸的比例，默认0.1
- **时间平滑σ**: 时间方向平滑的标准差，默认0（不启用）
- **参考帧数**: 用于计算参考图像的帧数，默认300

**预览控制：**
- **帧滑块**: 拖动查看不同帧

### 批量配准

1. 切换到"批量配准"标签页
2. 选择输入文件夹（包含多个TIFF文件）
3. 选择输出文件夹
4. （可选）选择自定义参考图像（将用于所有文件）
5. 调整配准参数（可选）
6. 点击"开始批量配准"

**批量处理特点：**
- 自动处理文件夹内所有TIFF文件
- 显示处理进度条
- 实时显示处理日志
- 每个文件独立配准，互不影响

## 输出文件

配准完成后会生成以下文件：

1. **配准后的TIFF文件**: `registered_*.tif`
2. **参考图像**: `*_ref.tif`（配准使用的参考图像）
3. **配准信息JSON**: `*_reg_info.json`（包含位移数据和相关性信息）

## 配准信息

JSON文件中包含以下信息：
- `ymax`, `xmax`: 每帧的Y和X方向位移
- `cmax`: 每帧的相关性系数
- `mean_shift_y`, `mean_shift_x`: 平均位移
- `mean_correlation`: 平均相关性
- `image_shape`: 图像尺寸
- `n_frames`: 帧数

## 技术特点

- 基于Suite2p的相位相关配准算法
- 多线程处理，避免界面卡顿
- 实时图像预览和参数调整
- 支持大文件处理，内存效率高

## 注意事项

1. 输入文件必须是TIFF格式的图像堆栈
2. 自定义参考图像尺寸应与输入数据一致
3. 批量处理时建议先测试单个文件
4. 大文件处理可能需要较长时间

## 故障排除

- **内存不足**: 减少参考帧数或分批处理
- **配准效果差**: 调整空间平滑参数或最大位移比例
- **文件读取错误**: 检查TIFF文件格式是否正确
